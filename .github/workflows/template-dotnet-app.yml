name: Reusable .NET Application Deployment

on:
  workflow_call:
    inputs:

      windows_host:
        description: 'Windows host IP address'
        required: true
        type: string
      dotnet_version:
        description: '.NET version to use'
        required: false
        type: string
        default: '6.0.x'
      app_name:
        description: 'Application name'
        required: false
        type: string
        default: 'CloudBuilderHelloWorld'
      deployment_path:
        description: 'Deployment path on Windows server'
        required: false
        type: string
        default: 'C:\Apps\WebApp'
      aws_region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-1'
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      WINDOWS_PASSWORD:
        required: true
      USERNAME:
        required: true
      PASSWORD:
        required: true
    outputs:
      application_url:
        description: "Application URL"
        value: ${{ jobs.deploy.outputs.application_url }}
      deployment_status:
        description: "Deployment status"
        value: ${{ jobs.deploy.outputs.deployment_status }}

env:
  DOTNET_VERSION: ${{ inputs.dotnet_version }}
  APP_NAME: ${{ inputs.app_name }}
  DEPLOYMENT_PATH: ${{ inputs.deployment_path }}

jobs:
  build:
    name: 'Build .NET Application'
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore app/dotnet-hello-world/${{ env.APP_NAME }}.csproj

    - name: Build application
      run: dotnet build app/dotnet-hello-world/${{ env.APP_NAME }}.csproj --configuration Release --no-restore

    - name: Test application
      run: dotnet test app/dotnet-hello-world/${{ env.APP_NAME }}.csproj --configuration Release --no-build --verbosity normal
      continue-on-error: true

    - name: Publish application
      run: dotnet publish app/dotnet-hello-world/${{ env.APP_NAME }}.csproj --configuration Release --output ./publish --no-build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-app
        path: ./publish
        retention-days: 30

  deploy:
    name: 'Deploy to Windows Server'
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ inputs.environment }}
    outputs:
      application_url: ${{ steps.app_url.outputs.application_url }}
      deployment_status: ${{ steps.deployment_status.outputs.deployment_status }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: dotnet-app
        path: ./publish

    - name: Setup Python for Ansible
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Ansible and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ansible pywinrm boto3 botocore

    - name: Install Ansible Collections
      run: |
        ansible-galaxy collection install ansible.windows
        ansible-galaxy collection install community.windows

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ inputs.aws_region }}

    - name: Create deployment package
      run: |
        cd publish
        zip -r ../app-deployment.zip .
        cd ..

    - name: Create inventory file
      run: |
        echo "[windows]" > inventory.ini
        echo "${{ inputs.windows_host }} ansible_host=${{ inputs.windows_host }}" >> inventory.ini

    - name: Create deployment playbook
      run: |
        cat > deploy-app.yml << 'EOF'
        ---
        - name: Deploy .NET Application to Windows IIS
          hosts: windows
          gather_facts: false
          vars:
            ansible_user: "${{ secrets.USERNAME }}"
            ansible_password: "${{ secrets.WINDOWS_PASSWORD }}"
            ansible_connection: winrm
            ansible_winrm_server_cert_validation: ignore
            ansible_winrm_transport: basic
            ansible_port: 5985
            app_name: "${{ env.APP_NAME }}"
            deployment_path: "${{ env.DEPLOYMENT_PATH }}"

          tasks:
            - name: Ensure deployment directory exists
              ansible.windows.win_file:
                path: "{{ deployment_path }}"
                state: directory

            - name: Stop IIS website
              community.windows.win_iis_website:
                name: "{{ app_name }}"
                state: stopped
              ignore_errors: true

            - name: Copy application files
              ansible.windows.win_copy:
                src: "./app-deployment.zip"
                dest: "C:\\Temp\\app-deployment.zip"

            - name: Extract application files
              community.windows.win_unzip:
                src: "C:\\Temp\\app-deployment.zip"
                dest: "{{ deployment_path }}"
                delete_archive: true

            - name: Create IIS Application Pool
              community.windows.win_iis_webapppool:
                name: "{{ app_name }}Pool"
                state: present
                attributes:
                  processModel.identityType: ApplicationPoolIdentity
                  recycling.periodicRestart.time: "1.05:00:00"
                  processModel.loadUserProfile: true

            - name: Create/Update IIS Website
              community.windows.win_iis_website:
                name: "{{ app_name }}"
                state: present
                port: 80
                ip: "*"
                hostname: ""
                application_pool: "{{ app_name }}Pool"
                physical_path: "{{ deployment_path }}"

            - name: Start IIS website
              community.windows.win_iis_website:
                name: "{{ app_name }}"
                state: started

            - name: Ensure IIS service is running
              ansible.windows.win_service:
                name: W3SVC
                state: started
                start_mode: auto

            - name: Test application endpoint
              ansible.windows.win_uri:
                url: "http://localhost"
                method: GET
                status_code: [200, 404]
              register: app_test
              retries: 3
              delay: 10

            - name: Display deployment result
              ansible.builtin.debug:
                msg: "Application deployed successfully! HTTP Status: {{ app_test.status_code }}"
        EOF

    - name: Deploy application
      run: |
        ansible-playbook deploy-app.yml -i inventory.ini -v

    - name: Set Application URL
      id: app_url
      run: |
        echo "application_url=http://${{ inputs.windows_host }}" >> $GITHUB_OUTPUT
        
    - name: Set Deployment Status
      id: deployment_status
      run: |
        echo "deployment_status=success" >> $GITHUB_OUTPUT

    - name: Verify deployment
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸ“± Application URL: http://${{ inputs.windows_host }}"
        echo "ğŸŒ IIS Website: ${{ env.APP_NAME }}"

  health-check:
    name: 'Post-Deployment Health Check'
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Wait for application startup
      run: sleep 30

    - name: Health check
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ inputs.windows_host }}/Home/Health || echo "000")
        if [ "$response" = "200" ]; then
          echo "âœ… Health check passed - Application is healthy"
        else
          echo "âš ï¸  Health check skipped - Endpoint may not exist (HTTP status: $response)"
        fi

    - name: Smoke test
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ inputs.windows_host }} || echo "000")
        if [ "$response" = "200" ]; then
          echo "âœ… Smoke test passed - Application is accessible"
          echo "ğŸŒ Application is live at: http://${{ inputs.windows_host }}"
        else
          echo "âŒ Smoke test failed - HTTP status: $response"
          echo "âš ï¸  Please check IIS configuration and application deployment"
        fi