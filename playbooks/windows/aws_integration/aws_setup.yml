---
- name: AWS Integration for Windows
  hosts: localhost
  gather_facts: false
  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"

  tasks:
    - name: Display AWS integration information
      ansible.builtin.debug:
        msg: 
          - "AWS Region: {{ aws_region | default('us-east-1') }}"
          - "Windows Host: {{ ansible_host }}"
          - "AWS integration setup completed"

    - name: Install AWS CLI tools on Windows (if needed)
      ansible.builtin.debug:
        msg: "AWS CLI can be installed on Windows instance if needed"

- name: Configure Windows instance
  hosts: windows
  gather_facts: false
  vars:
    ansible_user: Administrator
    ansible_password: "{{ hostvars['localhost']['windows_admin_password'] }}"
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_winrm_transport: basic
    ansible_port: 5985

  tasks:
    - name: Install AWS CLI
      ansible.windows.win_shell: |
        Invoke-WebRequest -Uri "https://awscli.amazonaws.com/AWSCLIV2.msi" -OutFile "C:\Temp\AWSCLIV2.msi"
        Start-Process msiexec.exe -Wait -ArgumentList '/I C:\Temp\AWSCLIV2.msi /quiet'

    - name: Configure AWS credentials
      ansible.windows.win_shell: |
        aws configure set aws_access_key_id "{{ aws_access_key }}"
        aws configure set aws_secret_access_key "{{ aws_secret_key }}"
        aws configure set default.region "{{ aws_region | default('us-east-1') }}"
      when: aws_access_key is defined and aws_secret_key is defined